name: ML Pipeline CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'  # Weekly retraining on Sunday 2 AM

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: |
          pytest tests/ --cov=. --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  train:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'   # <-- FIXED
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Prepare data
        run: python prepare_federated_data.py
      
      - name: Train model
        run: python federated_training_with_mlflow.py
      
      - name: Evaluate model
        run: python evaluate_federated_model.py
      
      - name: Check data drift
        run: python drift_detection.py
      
      - name: Upload model artifacts
        uses: actions/upload-artifact@v3
        with:
          name: trained-model
          path: federated_data/federated_churn_model.h5

  deploy:
    needs: train
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Download model
        uses: actions/download-artifact@v3
        with:
          name: trained-model
          path: federated_data/
      
      - name: Build Docker image
        run: |
          docker build -f Dockerfile.serving -t churn-api:latest .
      
      - name: Push to registry (placeholder)
        run: |
          echo "Would push to Docker Hub/ECR here"
      
      - name: Deploy to Kubernetes (placeholder)
        run: |
          echo "Would deploy to K8s here"

